<?xml version="1.0" encoding="UTF-8"?>
<project name="AsoBrain 3D Toolkit" default="release">
  <property file="../build.properties"/>
  <property name="build.sysclasspath" value="last"/>

  <include file="${include.pack200}"/>

  <target name="clean" depends="init" description="Remove temporary build files">
    <delete dir="classes"/>
    <delete dir="lib"/>
    <delete file="ab3d-test.jar"/>
  </target>

  <target name="build" depends="compile-java,compile-tests,jars.uptodate.check" unless="jars.uptodate" description="Build project">
    <mkdir dir="lib"/>
    <jar destfile="lib/ab3d.jar">
      <fileset dir="classes/java"/>
      <fileset dir="images"/>
    </jar>
    <jar destfile="ab3d-test.jar" basedir="classes/test"/>
  </target>

  <target name="jars.uptodate.check" depends="compile-java,compile-tests">
    <condition property="jars.uptodate">
      <and>
        <uptodate>
          <srcfiles dir="classes/java"/>
          <mapper type="merge" to="../../lib/ab3d.jar"/>
        </uptodate>
        <uptodate>
          <srcfiles dir="images"/>
          <mapper type="merge" to="../lib/ab3d.jar"/>
        </uptodate>
        <uptodate>
          <srcfiles dir="." includes="classes/test/**"/>
          <mapper type="merge" to="ab3d-test.jar"/>
        </uptodate>
      </and>
    </condition>
  </target>

  <target name="release" depends="build,pack200.uptodate.check" unless="pack200.uptodate" description="Build release">
    <repack200 jar="lib/ab3d.jar"/>
    <signjar keystore="${asobrain.cert.keystore}" storepass="${asobrain.cert.storepass}" alias="${asobrain.cert.alias}">
      <fileset file="lib/ab3d.jar" />
      <fileset file="ab3d-test.jar" />
    </signjar>
    <pack200 jar="lib/ab3d.jar"/>
  </target>

  <target name="pack200.uptodate.check" depends="build">
    <uptodate property="pack200.uptodate">
      <srcfiles dir="." includes="lib/*.jar,bin/*.jar" />
      <mapper type="glob" from="*.jar" to="*.jar.pack.gz"/>
    </uptodate>
  </target>

  <target name="init">
    <echo message="Project: ${ant.project.name}"/>
    <tstamp/>
    <available property="api.hsqldb"                     type="file" file="${hsqldb.jar}"/>
    <available property="api.jetbrains.annotations"      type="file" file="${jetbrains-annotations.jar}"/>
    <available property="api.jetbrains.javac2"           type="file" file="${jetbrains-javac2.jar}"/>
    <available property="api.jogl"                       type="file" file="${jogl.jar}"/>
    <available property="api.junit"                      type="file" file="${junit.jar}"/>
    <available property="api.numdata.oss"                type="file" file="${numdata.oss.home}/lib/numdata-oss.jar"/>
    <taskdef name="javac2" classname="com.intellij.ant.Javac2" classpathref="idea.lib.path"/>
  </target>

  <target name="api-check" depends="init" description="Pre-compilation initialization">
    <fail unless="api.hsqldb"                     message="Please check 'hsqldb' library presence and 'build.properties' file."/>
    <fail unless="api.jetbrains.annotations"      message="Please check 'JetBrains annotations' library presence and 'build.properties' file."/>
    <fail unless="api.jetbrains.javac2"           message="Please check 'JetBrains Javac2' library presence and 'build.properties' file."/>
    <fail unless="api.jogl"                       message="Please check 'JOGL' library presence and 'build.properties' file."/>
    <fail unless="api.junit"                      message="Please check 'JUnit' library presence and 'build.properties' file."/>
    <fail unless="api.numdata.oss"                message="Please check 'Numdata Open Source Software Library' presence and 'build.properties' file."/>
  </target>

  <path id="idea.lib.path">
    <pathelement location="${jetbrains-annotations.jar}"/>
    <pathelement location="${jetbrains-javac2.jar}"/>
    <pathelement location="${asm.jar}"/>
    <pathelement location="${asm-commons.jar}"/>
  </path>

  <path id="java.classpath">
    <pathelement location="classes/java"/>
    <pathelement location="${jetbrains-annotations.jar}"/>
    <pathelement location="${jogl.jar}"/>
    <pathelement location="${gluegen-rt.jar}"/>
    <pathelement location="${junit.jar}"/>
    <pathelement location="${numdata.oss.home}/lib/numdata-oss.jar"/>
  </path>

  <target name="compile-java" depends="api-check,java.uptodate.check" unless="java.uptodate" description="Compile Java source files">
    <mkdir dir="classes/java"/>
    <javac2 srcdir="java" destdir="classes/java" classpathref="java.classpath" source="1.5">
      <exclude name="**/jogl?*/**" />
      <exclude name="**/java3d/**" />
    </javac2>
    <copy todir="classes/java">
      <fileset dir="java" excludes="**/*.java" />
    </copy>
  </target>

  <target name="java.uptodate.check">
    <condition property="java.uptodate">
      <and>
        <uptodate>
          <srcfiles dir="." includes="java/**/*.java" excludes="**/jogl?*/**,**/java3d/**" />
          <mapper type="glob" from="*.java" to="classes/*.class"/>
        </uptodate>
        <uptodate>
          <srcfiles dir="." includes="java/**" excludes="**/*.java"/>
          <mapper type="glob" from="*" to="classes/*"/>
        </uptodate>
      </and>
    </condition>
  </target>

  <path id="test.classpath">
    <pathelement location="classes/test"/>
    <path refid="java.classpath"/>
    <pathelement location="${hsqldb.jar}"/>
    <pathelement location="${numdata.oss.home}/numdata-oss-test.jar"/>
  </path>

  <target name="compile-tests" depends="compile-java,tests.uptodate.check" unless="tests.uptodate" description="Compile unit tests">
    <mkdir dir="classes/test"/>
    <javac2 srcdir="test" destdir="classes/test" classpathref="test.classpath">
      <exclude name="**/jogl?*/**" />
      <exclude name="**/java3d/**" />
    </javac2>
    <copy todir="classes/test">
      <fileset dir="test" excludes="**/*.java"/>
    </copy>
  </target>

  <target name="tests.uptodate.check">
    <condition property="tests.uptodate">
      <and>
        <uptodate>
          <srcfiles dir="." includes="test/**/*.java" excludes="**/jogl?*/**,**/java3d/**" />
          <mapper type="glob" from="*.java" to="classes/*.class"/>
        </uptodate>
        <uptodate>
          <srcfiles dir="." includes="test/**" excludes="**/*.java"/>
          <mapper type="glob" from="*" to="classes/*"/>
        </uptodate>
      </and>
    </condition>
  </target>

  <target name="test" depends="compile-tests" description="Execute unit tests">
    <junit fork="yes" haltonfailure="on">
      <classpath refid="test.classpath"/>
      <test name="${testcase}" if="testcase"/>
      <batchtest unless="testcase">
        <fileset dir="classes/test">
          <include name="**/Test*.class"/>
          <exclude name="**/*$*"/>
        </fileset>
      </batchtest>
      <formatter type="brief" usefile="false"/>
    </junit>
  </target>
</project>
