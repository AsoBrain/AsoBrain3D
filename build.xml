<?xml version="1.0" encoding="UTF-8"?>
<project name="AsoBrain 3D Toolkit" default="all">
  <property file="build.properties"/>
  <property file="../build.properties"/>
  <property file="${user.home}/build.properties"/>
  <property name="build.sysclasspath" value="last"/>

  <target name="all" depends="dist,test" description="Generate distribution files and run unit tests"/>

  <target name="clean" depends="init" description="Remove temporary build files">
    <delete dir="classes"/>
    <delete dir="lib"/>
  </target>

  <target name="compile" depends="compile-java,compile-tests" description="Compile everything"/>

  <target name="dist" depends="compile,dist-java" description="Generate distribution files"/>

  <target name="init">
    <tstamp/>
    <available property="api.jogl"        type="file" file="${jogl.home}/lib/jogl.jar"/>
    <available property="api.numdata.oss" type="file" file="${numdata.oss.home}/lib/numdata-oss.jar"/>
  </target>

  <target name="api-check" depends="init" description="Pre-compilation initialization">
    <mkdir dir="classes/test"/>
    <javac srcdir="test" destdir="classes/test" includes="apicheck/ApiCheck.java"/>
    <java classname="apicheck.ApiCheck" classpath="classes/test" classpathref="java.classpath" failonerror="yes"/>
    <fail unless="api.jogl"        message="Please check 'JOGL' library presence and 'build.properties' file."/>
    <fail unless="api.numdata.oss" message="Please check 'Numdata Open Source Software Library' presence and 'build.properties' file."/>
  </target>

  <path id="java.classpath">
    <pathelement location="classes"/>
    <pathelement location="${numdata.oss.home}/lib/numdata-oss.jar"/>
    <pathelement location="${jogl.home}/lib/jogl.jar"/>
    <pathelement location="${jogl.home}/lib/gluegen-rt.jar"/>
  </path>

  <target name="compile-java" depends="api-check" description="Compile Java source files">
    <mkdir dir="classes"/>
    <javac srcdir="java" destdir="classes" classpathref="java.classpath" source="1.5"/>
    <copy todir="classes">
      <fileset dir="java" includes="**/*.properties"/>
    </copy>
  </target>

  <target name="dist-java" depends="compile-java" description="Generate Java distribution files">
    <mkdir dir="lib"/>
    <jar destfile="lib/ab3d.jar" basedir="classes" excludes="test/**,**/.dependency-info/**"/>
  </target>

  <path id="test.classpath">
    <pathelement location="classes/test"/>
    <path refid="java.classpath"/>
  </path>

  <target name="compile-tests" depends="compile-java" description="Compile unit tests">
    <mkdir dir="classes/test"/>
    <javac srcdir="test" destdir="classes/test" classpathref="test.classpath" />
    <copy todir="classes/test">
      <fileset dir="test" excludes="**/*.java"/>
    </copy>
  </target>

  <target name="test" depends="compile-tests" description="Execute unit tests">
    <junit fork="yes" haltonfailure="on">
      <classpath refid="test.classpath"/>
      <test name="${testcase}" if="testcase"/>
      <batchtest unless="testcase">
        <fileset dir="classes/test">
          <include name="**/Test*.class"/>
          <exclude name="**/*$*"/>
        </fileset>
      </batchtest>
      <formatter type="brief" usefile="false"/>
    </junit>
  </target>
</project>
