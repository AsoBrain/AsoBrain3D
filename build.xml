<?xml version="1.0" encoding="UTF-8"?>
<project name="AsoBrain 3D Toolkit" default="build">
  <property file="../build.properties"/>
  <property name="build.sysclasspath" value="last"/>

  <macrodef name="repack200">
    <attribute name="jar"/>
    <sequential>
      <echo message="Repacking '@{jar}' with pack200"/>
      <exec executable="pack200" failonerror="yes">
        <arg value="--repack"/>
        <arg value="--unknown-attribute=error"/>
        <arg value="@{jar}"/>
      </exec>
    </sequential>
  </macrodef>

  <macrodef name="pack200">
    <attribute name="jar"/>
    <sequential>
      <echo message="Compressing '@{jar}' to '@{jar}.pack.gz' with pack200"/>
      <exec executable="pack200" failonerror="yes">
        <arg value="--gzip"/>
        <arg value="--unknown-attribute=error"/>
        <arg value="--keep-file-order"/>
        <arg value="@{jar}.pack.gz"/>
        <arg value="@{jar}"/>
      </exec>
    </sequential>
  </macrodef>

  <target name="clean" depends="init" description="Remove temporary build files">
    <delete dir="classes"/>
    <delete dir="lib"/>
  </target>

  <target name="build" depends="compile-java,compile-tests" description="Build project">
    <mkdir dir="lib"/>
    <jar destfile="lib/ab3d.jar" basedir="classes/java"/>
    <jar destfile="lib/ab3d-test.jar" basedir="classes/test"/>
  </target>

  <target name="release" depends="build" description="Build release">
    <repack200 jar="lib/ab3d.jar"/>
    <signjar keystore="${asobrain.cert.keystore}" storepass="${asobrain.cert.storepass}" alias="${asobrain.cert.alias}">
      <fileset file="lib/ab3d.jar" />
      <fileset file="lib/ab3d-test.jar" />
    </signjar>
    <pack200 jar="lib/ab3d.jar"/>
  </target>

  <target name="init">
    <tstamp/>
    <available property="api.hsqldb"                     type="file" file="${hsqldb.jar}"/>
    <available property="api.jetbrains.annotations"      type="file" file="${jetbrains-annotations.jar}"/>
    <available property="api.jetbrains.javac2"           type="file" file="${jetbrains-javac2.jar}"/>
    <available property="api.jogl"                       type="file" file="${jogl.jar}"/>
    <available property="api.junit"                      type="file" file="${junit.jar}"/>
    <available property="api.numdata.oss"                type="file" file="${numdata.oss.home}/lib/numdata-oss.jar"/>
    <taskdef name="javac2" classname="com.intellij.ant.Javac2" classpathref="idea.lib.path"/>
  </target>

  <target name="api-check" depends="init" description="Pre-compilation initialization">
    <fail unless="api.hsqldb"                     message="Please check 'hsqldb' library presence and 'build.properties' file."/>
    <fail unless="api.jetbrains.annotations"      message="Please check 'JetBrains annotations' library presence and 'build.properties' file."/>
    <fail unless="api.jetbrains.javac2"           message="Please check 'JetBrains Javac2' library presence and 'build.properties' file."/>
    <fail unless="api.jogl"                       message="Please check 'JOGL' library presence and 'build.properties' file."/>
    <fail unless="api.junit"                      message="Please check 'JUnit' library presence and 'build.properties' file."/>
    <fail unless="api.numdata.oss"                message="Please check 'Numdata Open Source Software Library' presence and 'build.properties' file."/>
  </target>

  <path id="idea.lib.path">
    <pathelement location="${jetbrains-annotations.jar}"/>
    <pathelement location="${jetbrains-javac2.jar}"/>
    <pathelement location="${asm.jar}"/>
    <pathelement location="${asm-commons.jar}"/>
  </path>

  <path id="java.classpath">
    <pathelement location="classes/java"/>
    <pathelement location="${jetbrains-annotations.jar}"/>
    <pathelement location="${jogl.jar}"/>
    <pathelement location="${gluegen-rt.jar}"/>
    <pathelement location="${junit.jar}"/>
    <pathelement location="${numdata.oss.home}/lib/numdata-oss.jar"/>
  </path>

  <target name="compile-java" depends="api-check" description="Compile Java source files">
    <mkdir dir="classes/java"/>
    <javac2 srcdir="java" destdir="classes/java" classpathref="java.classpath" source="1.5">
      <exclude name="**/jogl?*/**" />
      <exclude name="**/java3d/**" />
    </javac2>
    <copy todir="classes/java">
      <fileset dir="java" excludes="**/*.java" />
    </copy>
  </target>

  <path id="test.classpath">
    <pathelement location="classes/test"/>
    <path refid="java.classpath"/>
    <pathelement location="${hsqldb.jar}"/>
    <pathelement location="${numdata.oss.home}/lib/numdata-oss-test.jar"/>
  </path>

  <target name="compile-tests" depends="compile-java" description="Compile unit tests">
    <mkdir dir="classes/test"/>
    <javac2 srcdir="test" destdir="classes/test" classpathref="test.classpath">
      <exclude name="**/jogl?*/**" />
      <exclude name="**/java3d/**" />
    </javac2>
    <copy todir="classes/test">
      <fileset dir="test" excludes="**/*.java"/>
    </copy>
  </target>

  <target name="test" depends="compile-tests" description="Execute unit tests">
    <junit fork="yes" haltonfailure="on">
      <classpath refid="test.classpath"/>
      <test name="${testcase}" if="testcase"/>
      <batchtest unless="testcase">
        <fileset dir="classes/test">
          <include name="**/Test*.class"/>
          <exclude name="**/*$*"/>
        </fileset>
      </batchtest>
      <formatter type="brief" usefile="false"/>
    </junit>
  </target>
</project>
